-- CALCULATE the spread 
 CREATE OR REPLACE STREAM "DESTINATION_SQL_STREAM" (
                            COL_bidprice INTEGER,
                            COL_askprice INTEGER,
                            spread double);
-- CREATE OR REPLACE PUMP to insert into output
CREATE OR REPLACE PUMP "STREAM_PUMP" AS 
  INSERT INTO "DESTINATION_SQL_STREAM" 
      SELECT STREAM COL_bidprice, 
                    COL_askprice,
      FROM   "SOURCE_SQL_STREAM_001"
      WHERE  ABS((COL_bidprice-COL_askprice)=spread)

-- Calculate min, max and average for Bid price. 
CREATE OR REPLACE STREAM "DESTINATION_SQL_STREAM" (
                         COL_bidprice INTEGER, 
                         Min_bidPrice double, 
                         Max_bidPrice double, 
                         Avg_bidPrice double);
CREATE OR REPLACE PUMP "STREAM_PUMP" AS 
   INSERT INTO "DESTINATION_SQL_STREAM"
     SELECT STREAM COL_bidprice,
                   MIN(Price) OVER W1 AS Min_bidPrice,
                   MAX(Price) OVER W1 AS Max_bidPrice,
                   AVG(Price) OVER W1 AS Avg_bidPrice
     FROM   "SOURCE_SQL_STREAM_001"
     WINDOW W1 AS (
        PARTITION BY COL_bidprice 
        RANGE INTERVAL '1' MINUTE PRECEDING);     
-- Calculate min, max and average for Ask Price 
CREATE OR REPLACE STREAM "DESTINATION_SQL_STREAM" (
                         COL_askprice INTEGER, 
                         Min_Price     double, 
                         Max_Price     double, 
                         Avg_Price     double);
CREATE OR REPLACE PUMP "STREAM_PUMP" AS 
   INSERT INTO "DESTINATION_SQL_STREAM"
     SELECT STREAM COL_askprice,
                   MIN(Price) OVER W1 AS Min_askPrice,
                   MAX(Price) OVER W1 AS Max_askPrice,
                   AVG(Price) OVER W1 AS Avg_askPrice
     FROM   "SOURCE_SQL_STREAM_001"
     WINDOW W1 AS (
        PARTITION BY COL_askprice 
        RANGE INTERVAL '1' MINUTE PRECEDING);     


